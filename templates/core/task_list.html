{% extends 'base.html' %}
{% load static %}

{% block page_header %}
<div class="row mb-4">
    <div class="col">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 mb-1 text-dark fw-bold">
                    <i class="fas fa-list me-2 text-primary"></i>
                    {{ title }}
                </h1>
                <p class="text-muted mb-0">{{ description }}</p>
            </div>
            <div class="text-end">
                <a href="{% url 'core:task_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>New Task
                </a>
            </div>
        </div>
        <hr class="my-3 border-primary">
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Search and Filter Section -->
<div class="filter-section">
    <form method="GET" class="row g-3">
        <div class="col-md-4">
            <div class="search-input">
                <i class="fas fa-search search-icon"></i>
                <input type="text" 
                       class="form-control" 
                       name="search" 
                       value="{{ search_query }}"
                       placeholder="Search by title, description, or tags...">
            </div>
        </div>
        <div class="col-md-2">
            <select class="form-select" name="status">
                <option value="">All Statuses</option>
                {% for status_value, status_label in status_choices %}
                    <option value="{{ status_value }}" {% if status_value == status_filter %}selected{% endif %}>
                        {{ status_label }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" name="priority">
                <option value="">All Priorities</option>
                {% for priority_value, priority_label in priority_choices %}
                    <option value="{{ priority_value }}" {% if priority_value == priority_filter %}selected{% endif %}>
                        {{ priority_label }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" name="assignment">
                <option value="">All Tasks</option>
                <option value="assigned_to_me" {% if assignment_filter == 'assigned_to_me' %}selected{% endif %}>Assigned to Me</option>
                <option value="created_by_me" {% if assignment_filter == 'created_by_me' %}selected{% endif %}>Created by Me</option>
            </select>
        </div>
        <div class="col-md-2">
            <div class="d-grid">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter me-1"></i>Filter
                </button>
            </div>
        </div>
    </form>
    
    {% if search_query or status_filter or priority_filter or assignment_filter %}
    <div class="mt-3">
        <small class="text-muted">
            Active filters: 
            {% if search_query %}<span class="badge bg-secondary me-1">Search: "{{ search_query }}"</span>{% endif %}
            {% if status_filter %}<span class="badge bg-info me-1">Status: {{ status_filter|title }}</span>{% endif %}
            {% if priority_filter %}<span class="badge bg-warning me-1">Priority: {{ priority_filter|title }}</span>{% endif %}
            {% if assignment_filter %}<span class="badge bg-success me-1">Assignment: {{ assignment_filter|title }}</span>{% endif %}
            <a href="{% url 'core:task_list' %}" class="text-decoration-none ms-2">Clear all</a>
        </small>
    </div>
    {% endif %}
</div>

<!-- Tasks Grid -->
{% if page_obj.object_list %}
    <div class="row">
        {% for task in page_obj.object_list %}
        <div class="col-lg-4 col-md-6 mb-4 fade-in">
            <div class="card task-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold">{{ task.title|truncatechars:30 }}</h6>
                    {% if task.is_overdue %}
                        <i class="fas fa-exclamation-triangle text-danger" title="Overdue"></i>
                    {% endif %}
                </div>
                <div class="card-body d-flex flex-column">
                    {% if task.description %}
                        <p class="task-description text-muted small mb-3">
                            {{ task.description|truncatewords:20 }}
                        </p>
                    {% endif %}
                    
                    <!-- Status and Priority Badges -->
                    <div class="mb-3">
                        <span class="status-badge status-{{ task.status }} me-1">{{ task.get_status_display }}</span>
                        <span class="priority-badge priority-{{ task.priority }}">{{ task.get_priority_display }}</span>
                    </div>
                    
                    <!-- Task Meta Information -->
                    <div class="small text-muted mb-3">
                        {% if task.assigned_to %}
                            <div class="mb-1">
                                <i class="fas fa-user me-1"></i>Assigned to: {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}
                            </div>
                        {% endif %}
                        
                        {% if task.due_date %}
                            <div class="mb-1">
                                <i class="fas fa-calendar me-1"></i>
                                <span class="{% if task.is_overdue %}text-danger{% else %}text-muted{% endif %}">
                                    Due: {{ task.due_date|date:"M d, Y" }}
                                </span>
                            </div>
                        {% endif %}
                        
                        {% if task.tags %}
                            <div class="mb-1">
                                <i class="fas fa-tags me-1"></i>
                                {% for tag in task.get_tags_list %}
                                    <span class="badge bg-light text-dark border me-1">{{ tag }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <div>
                            <i class="fas fa-clock me-1"></i>Created {{ task.created_at|timesince }} ago
                        </div>
                    </div>
                    
                    <!-- Progress Bar (if hours are set) -->
                    {% if task.estimated_hours and task.actual_hours %}
                        <div class="mb-3">
                            <small class="text-muted mb-1 d-block">Progress</small>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-primary" role="progressbar" 
                                     style="width: {% widthratio task.actual_hours task.estimated_hours 100 %}%">
                                </div>
                            </div>
                            <small class="text-muted">{{ task.actual_hours }}/{{ task.estimated_hours }} hours</small>
                        </div>
                    {% endif %}
                    
                    <!-- Action Buttons -->
                    <div class="mt-auto">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <a href="{% url 'core:task_detail' task.id %}" class="btn btn-sm btn-outline-primary action-btn btn-view">
                                    <i class="fas fa-eye me-1"></i>View
                                </a>
                                <a href="{% url 'core:task_edit' task.id %}" class="btn btn-sm btn-outline-warning action-btn btn-edit">
                                    <i class="fas fa-edit me-1"></i>Edit
                                </a>
                            </div>
                            <div>
                                {% if task.status != 'completed' %}
                                    <a href="{% url 'core:task_complete' task.id %}" class="btn btn-sm btn-success">
                                        <i class="fas fa-check"></i>
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <nav aria-label="Task pagination">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}{% if priority_filter %}priority={{ priority_filter }}&{% endif %}{% if assignment_filter %}assignment={{ assignment_filter }}&{% endif %}page={{ page_obj.previous_page_number }}">
                        <i class="fas fa-chevron-left"></i> Previous
                    </a>
                </li>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}{% if priority_filter %}priority={{ priority_filter }}&{% endif %}{% if assignment_filter %}assignment={{ assignment_filter }}&{% endif %}page={{ num }}">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}{% if priority_filter %}priority={{ priority_filter }}&{% endif %}{% if assignment_filter %}assignment={{ assignment_filter }}&{% endif %}page={{ page_obj.next_page_number }}">
                        Next <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

{% else %}
    <!-- Empty State -->
    <div class="empty-state">
        <i class="fas fa-search"></i>
        {% if search_query or status_filter or priority_filter or assignment_filter %}
            <h4>No tasks found</h4>
            <p>No tasks match your current search criteria. Try adjusting your filters.</p>
            <a href="{% url 'core:task_list' %}" class="btn btn-outline-primary">Clear Filters</a>
        {% else %}
            <h4>No tasks yet</h4>
            <p>Create your first task to get started with task management!</p>
            <a href="{% url 'core:task_create' %}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Create Your First Task
            </a>
        {% endif %}
    </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add fade-in animation to cards
    setTimeout(() => {
        document.querySelectorAll('.fade-in').forEach((el, index<｜tool▁call▁begin｜>
            setTimeout(() => {
                el.classList.add('fade-in');
            }, index * 100);
        });
    }, 100);
    
    // Auto-submit form on filter changes
    document.querySelectorAll('select[name="status"], select[name="priority"], select[name="assignment"]').forEach(select => {
        select.addEventListener('change', function() {
            this.form.submit();
        });
    });
    
    // Clear search input
    document.querySelector('input[name="search"]').addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            this.value = '';
            this.form.submit();
        }
    });
});
</script>
{% endblock %}
